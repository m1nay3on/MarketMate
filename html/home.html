<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MarketMate Dashboard</title>
  <link rel="stylesheet" href="../css/home.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Aoboshi+One&display=swap" rel="stylesheet">

  <!-- Font Awesome for search icon -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />
</head>
<body>
 <div class="layout" id="layout">

<aside class="sidebar" id="sidebar">
      <!-- Top -->
  

      
      <!-- Close button -->
      <button class="close-btn" onclick="closeSidebar()">
        <i class="fa-solid fa-xmark"></i>
      </button>

      <!-- Menu -->
     <ul class="menu">
        <li>
          <a href="home.html"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
        </li>
        <li>
          <a href="order.html"><i class="fa-solid fa-box"></i> Orders</a>
        </li>
        <li>
          <a href="customer.html"><i class="fa-solid fa-users"></i> Customers</a>
        </li>
        <li>
          <a href="shipping.html"><i class="fa-solid fa-truck"></i> Shipping</a>
        </li>
        <li>
          <a href="items.html"><i class="fa-solid fa-cubes"></i> Items</a>
        </li>
        <li>
          <a href="reviews.html"><i class="fa-solid fa-star"></i> Reviews</a>
        </li>
        <li>
          <a href="payments.html"><i class="fa-solid fa-store"></i> Payments</a>
        </li>
        <li>
          <a href="rewards.html"><i class="fa-solid fa-gift"></i> Rewards</a>
        </li>

        <li class="section">Account</li>
        <li>
          <a href="home.html"><i class="fa-solid fa-house"></i> Home</a>
        </li>

        <li class="logout">
          <a href="#" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
        </li>
      </ul>
    </aside>

  <div class="content-wrapper">
  <nav class="navbar">
 <button class="open-btn" onclick="openSidebar()">
  <i class="fa-solid fa-bars"></i>
</button>


  <img src="../images/MarketMate.png" class="logo" />

  <div class="search-container">
    <i class="fa fa-search"></i>
    <input type="text" placeholder="Search" />
  </div>


  <div class="profile">
    <img src="../images/ppft.png" />
  </div>
</nav>


    <main class="main-content">
      <!-- Header -->
      <div class="page-header">
        <h1 id="shopTitle">Dashboard</h1>
        <p>View your shop‚Äôs progress report and activity</p>
      </div>

      <!-- Stat Cards -->
      <section class="stats">
        <div class="stat-card dark">
          <span>Total Orders</span>
          <h2 id="totalOrders">0</h2>
        </div>

        <div class="stat-card">
          <span><i class="dot green"></i> Active Orders</span>
          <h2 id="activeOrders">0</h2>
        </div>

        <div class="stat-card">
          <span><i class="dot yellow"></i> To Ship</span>
          <h2 id="toShip">0</h2>
        </div>

        <div class="stat-card">
          <span><i class="dot blue"></i> Total Revenue</span>
          <h2 id="totalRevenue">‚Ç±0</h2>
        </div>
      </section>

      <!-- Dashboard Grid -->
      <section class="dashboard-grid">
        <div class="card sales-card">
          <h3>üìä Summary</h3>
          <div class="sales-content">
            <div class="summary-grid">
              <div class="summary-item">
                <span class="summary-value" id="totalCustomers">0</span>
                <span class="summary-label">Customers</span>
              </div>
              <div class="summary-item">
                <span class="summary-value" id="totalItems">0</span>
                <span class="summary-label">Items</span>
              </div>
              <div class="summary-item">
                <span class="summary-value" id="totalPayments">0</span>
                <span class="summary-label">Payments</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card full">
          <h3>‚≠ê Top Selling Items</h3>
          <div id="topItemsList" class="top-items-list">
            <p class="no-data">Loading...</p>
          </div>
        </div>

        <div class="card feedback-card">
          <h3>‚ù§Ô∏è Recent Customer Feedback</h3>
          <div class="rating">
            <div class="score" id="avgRating">0<sub>/5</sub></div>
            <span class="rating-label">Average Rating</span>
          </div>

          <div id="recentReviews">
            <div class="review">
              <strong>Loading...</strong>
            </div>
          </div>
        </div>
      </section>
     </main>
    </div>
  </div>

  <script src="../js/api.js"></script>
  <script>
  const sidebar = document.getElementById("sidebar");
  const layout = document.getElementById("layout");

  function closeSidebar() {
    sidebar.classList.add("closed");
    layout.classList.add("sidebar-closed");
  }

  function openSidebar() {
    sidebar.classList.remove("closed");
    layout.classList.remove("sidebar-closed");
  }

  function logout() {
    TokenManager.removeToken();
    window.location.href = 'Sign-In.html';
  }

  // Load dashboard data
  async function loadDashboard() {
    // Check if user is authenticated
    if (!TokenManager.isAuthenticated()) {
      window.location.href = 'Sign-In.html';
      return;
    }

    try {
      // Load user info
      const user = await API.getCurrentUser();
      const shopTitle = document.getElementById('shopTitle');
      if (shopTitle) {
        shopTitle.textContent = `${user.shop_name || user.username}'s Dashboard`;
      }
      
      // Load stats
      const stats = await API.getDashboardStats();
      updateElement('totalOrders', stats.total_orders.toLocaleString());
      updateElement('activeOrders', stats.active_orders.toLocaleString());
      updateElement('toShip', stats.to_ship.toLocaleString());
      updateElement('totalRevenue', '‚Ç±' + Number(stats.total_revenue).toLocaleString());
      updateElement('totalCustomers', stats.total_customers.toLocaleString());
      updateElement('totalItems', stats.total_items.toLocaleString());
      updateElement('totalPayments', stats.total_orders.toLocaleString());
      
      // Load top items
      await loadTopItems();
      
      // Load recent reviews
      await loadRecentReviews();
      
    } catch (error) {
      console.error('Error loading dashboard:', error);
    }
  }

  function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
      element.textContent = value;
    }
  }

  async function loadTopItems() {
    try {
      const items = await API.getTopItems();
      const container = document.getElementById('topItemsList');
      
      if (!container) return;
      
      if (items.length === 0) {
        container.innerHTML = '<p class="no-data">No items sold yet</p>';
        return;
      }
      
      container.innerHTML = items.map((item, index) => `
        <div class="top-item">
          <span class="rank">#${index + 1}</span>
          <span class="item-name">${item.name}</span>
          <span class="item-count">${item.count} orders</span>
        </div>
      `).join('');
      
    } catch (error) {
      console.error('Error loading top items:', error);
      document.getElementById('topItemsList').innerHTML = '<p class="no-data">Failed to load</p>';
    }
  }

  async function loadRecentReviews() {
    try {
      const reviews = await API.getRecentReviews();
      const container = document.getElementById('recentReviews');
      
      if (!container) return;
      
      if (reviews.length === 0) {
        container.innerHTML = '<div class="review"><p class="no-data">No reviews yet</p></div>';
        // Update average rating to 0
        updateElement('avgRating', '0');
        return;
      }
      
      // Calculate average rating
      const avgRating = reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length;
      const avgElement = document.getElementById('avgRating');
      if (avgElement) {
        avgElement.innerHTML = `${avgRating.toFixed(1)}<sub>/5</sub>`;
      }
      
      container.innerHTML = reviews.map(review => `
        <div class="review">
          <div class="review-header">
            <strong>${review.item_name}</strong>
            <span class="review-rating">${'‚òÖ'.repeat(Math.round(review.rating))}</span>
          </div>
          <p class="review-comment">${review.comment || 'No comment'}</p>
          <span class="review-author">- ${review.customer_name}</span>
        </div>
      `).join('');
      
    } catch (error) {
      console.error('Error loading reviews:', error);
      document.getElementById('recentReviews').innerHTML = '<div class="review"><p class="no-data">Failed to load</p></div>';
    }
  }

  loadDashboard();
</script>


</body>
</html>